{% load static sekizai_tags %}

<div class="modal fade code-modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Source Code</h4>
            </div>
            <div class="modal-body">
                <pre contenteditable></pre>
            </div>
        </div>
    </div>
</div>

{% addtoblock "js" %}<script defer src="{% static 'js/addons/jquery.select2.min.js' %}"></script>{% endaddtoblock %}
{% addtoblock "js" %}
<script defer>
/* global StyleguideIcons */
window.onload = function () {
    // ensure namespace is available
    window.Cl = window.Cl || {};
    Cl.Styleguide = {

        init: function () {
            this.container = $('.styleguide');
            // load modules
            this.menu();
            this.icons();
            this.copy();
            this.forms();
        },

        menu: function () {
            var that = this;
            var lists = this.container.find('.navbar-styleguide li');
            var triggers = lists.find('a');
            var hash, container;

            triggers.on('click', function (e) {
                e.preventDefault();

                // reset active classes
                lists.removeClass('active');
                $(this).parent().addClass('active');

                // handle containers
                that.container.find('> section').hide();
                hash = $(this).attr('href').replace('#', '');
                container = that.container.find('> section[data-id="' + hash + '"]');
                container.show();

                // update history
                if (window.history && window.history.replaceState) {
                    history.replaceState('styleguide', hash, '#' + hash);
                }
            });

            // setup first element
            if (window.history && history.state === 'styleguide' || window.history && window.location.hash) {
                lists.find('a[href="' + window.location.hash + '"]').trigger('click');
            } else {
                triggers.eq(0).trigger('click');
            }
        },

        icons: function () {
            $.ajax('{% static "iconset.json" %}').then((response) => {
                var output = '';
                var container = this.container.find('.iconlist-render');
                var icons = StyleguideIcons;

                icons['Divio Icons'] = response.icons;
                for (var key in icons) {
                    var spriteName = {
                        'Divio Icons': 'icons',
                    }[key];
                    output += '<h3>' + key + '</h3><div class="row">';
                    for (var i = 0; i < icons[key].length; i++) {
                        output += '<div class="col-lg-3 col-md-4 col-sm-6"><p><span style="vertical-align: middle; font-size: 30px; margin-right: 10px;" class="icon icon-' + icons[key][i] + '"><svg role="presentation"><use xlink:href="{% static "sprites/" %}' + spriteName + '.svg#' + icons[key][i] + '"></use></svg></span> <code style="display: inline-block; vertical-align: middle">' + icons[key][i] + '</code></p></div>';
                    }
                    output += '</div>';
                }
                container.html(output);
            });
        },

        copy: function () {
            var tpl = '<div class="btn btn-primary btn-xs code-button">Copy</div>';
            var button = $(tpl).on('click', function () {
                var html = $(this).parent().clone()
                    .find('.code-button').remove().end()
                    .html();
                html = cleanSource(html);
                $('.code-modal pre').text(html);
                $('.code-modal').modal();
            });

            $('.code-container [data-toggle="popover"]').popover();
            $('.code-container [data-toggle="tooltip"]').tooltip();

            $('.code-container').hover(function () {
                $(this).append(button);
                button.show();
            }, function () {
                button.hide();
            });

            function cleanSource(html) {
                return html_beautify(html, {
                    preserve_newlines: false
                });
            }
        },

        forms: function () {
            // add select2 if available
            if (jQuery.fn.select2) {
                $('#field-select2').select2();
            }
        }

    };
    Cl.Styleguide.init();
    setTimeout(function () {
        $(window).trigger('resize');
    });
};
</script>
{% endaddtoblock %}
{% addtoblock "css" %}
<style>
.iconlist-render h3 { text-transform:capitalize; }
.iconlist-render p:hover span { transform:scale(2); }

.color-swatch { float:left; width:50px; height:50px; margin:0 5px 5px 0; border-radius:3px; }
.code-container { position:relative; }
.code-button { position:absolute; right:0; top:0; z-index:9999; }

.styleguide-grid .row > div { background:#e4f0f5; border:1px solid #e4f0f5; }
.styleguide-grid .row > div p { display:block; color:white; font-size:90%; text-align:center; margin:0;
    padding:15px 0; background:#069; opacity:0.5; }
</style>
{% endaddtoblock %}
